_target_: aics_im2im.models.im2im.MultiTaskIm2Im

save_images_every_n_epochs: 10
save_dir: ${paths.output_dir}
x_key: raw
patch_shape:

backbone:
  _target_: monai.networks.nets.DynUNet
  spatial_dims: 3
  in_channels: 1
  out_channels: 128
  strides: [1, 2, 2, 2, 2]
  kernel_size: [3, 3, 3, 3, 3]
  upsample_kernel_size: [2, 2, 2, 2]
  filters: [64, 128, 256, 512, 768]
  dropout: 0.1
  res_block: True

tasks:
  seg:
    head:
      _target_: aics_im2im.nn.AuxHead
      resolution: lr
      in_channels: 128
      out_channels: 1
      spatial_dims: 3
      dropout: 0.1
      n_convs: 3
      final_act:
        _target_: torch.nn.Identity
    loss:
      _target_: aics_im2im.utils.loss_wrapper.CMAP_loss
      loss:
        _target_: torch.nn.BCEWithLogitsLoss
        reduction: none
        pos_weight:
          _target_: torch.tensor
          data:
            - 10.0
  mitotic_mask:
    head:
      _target_: aics_im2im.nn.AuxHead
      resolution: lr
      in_channels: 128
      out_channels: 3
      spatial_dims: 2
      dropout: 0.1
      n_convs: 3
      final_act:
        _target_: torch.nn.Identity
      first_layer:
        _target_: aics_im2im.nn.aux_head.ConvProjectionLayer
        dim: 2
        pool_size: 64
        in_channels: 128
        out_channels: 128
    loss:
      _target_: aics_im2im.utils.loss_wrapper.CMAP_loss
      loss:
        _target_: torch.nn.CrossEntropyLoss
        reduction: none
        weight:
          _target_: torch.tensor
          data: [1, 10.0, 10.0]

optimizer:
  generator:
    _partial_: True
    _target_: torch.optim.Adam
    lr: 0.0003
    weight_decay: 0.0001

lr_scheduler:
  generator:
    _partial_: True
    _target_: torch.optim.lr_scheduler.ExponentialLR
    gamma: 0.995

postprocessing:
  input:
    raw:
      _target_: aics_im2im.models.im2im.utils.postprocessing.rescale
      _partial_: True
    seg:
      _target_: aics_im2im.models.im2im.utils.postprocessing.rescale
      _partial_: True
    mitotic_mask:
      _target_: aics_im2im.models.im2im.utils.postprocessing.rescale
      _partial_: True

  prediction:
    seg:
      _target_: aics_im2im.models.im2im.utils.postprocessing.sigmoid_rescale
      _partial_: True
    mitotic_mask:
      _target_: aics_im2im.models.im2im.utils.postprocessing.sigmoid_rescale
      _partial_: True
